roles:
  training.*:
    scheduling:
      require:
        - training
    rules:
    - if: |
        from tpv.core.entities import Tool
        include_tags = []
        exclude_tags = ['pulsar', 'training-exempt']
        value = False
        for ent in filter(lambda x: isinstance(x, Tool), entities):  # there should be exactly one of these
            value = (
              all([ent.tags.filter(tag_value=tag_name) for tag_name in include_tags])
              and not any([ent.tags.filter(tag_value=tag_name) for tag_name in exclude_tags])
            )
        value
      cores: 2
      mem: cores * 3.8
      context:
        partition: training
      scheduling:
        require:
          - slurm
    - if: |
        from tpv.core.entities import Tool
        include_tags = ['pulsar']
        exclude_tags = ['pulsar-training-large', 'training-exempt']
        value = False
        for ent in filter(lambda x: isinstance(x, Tool), entities):
            value = (
              all([ent.tags.filter(tag_value=tag_name) for tag_name in include_tags])
              and not any([ent.tags.filter(tag_value=tag_name) for tag_name in exclude_tags])
            )
        value
      cores: 4
      mem: cores * 2.9  # ratio for pulsar-nci-training
      scheduling:
        require:
          - pulsar  # require pulsar and training: only one place to go
    - if: |
        from tpv.core.entities import Tool
        include_tags = ['pulsar-training-large']
        exclude_tags = ['training-exempt']
        value = False
        for ent in filter(lambda x: isinstance(x, Tool), entities):
            value = (
              all([ent.tags.filter(tag_value=tag_name) for tag_name in include_tags])
              and not any([ent.tags.filter(tag_value=tag_name) for tag_name in exclude_tags])
            )
        value
      cores: 16
      mem: cores * 2.9  # ratio for pulsar-nci-training
      scheduling:
        require:
          - pulsar  # require pulsar and training: only one place to go
